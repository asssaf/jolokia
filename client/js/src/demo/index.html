<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<script src='../json2.js' type='text/javascript'></script>
<script src='../JolokiaJS.js' type='text/javascript'></script>
<script src='jquery-1.4.2.min.js' type='text/javascript'></script>
<script language="javascript" type="text/javascript" src="jquery.flot.js"></script>
<script language="javascript" type="text/javascript" src="jquery.timers-1.2.js"></script>
<head>
    <title>j4pjs test/demo</title>
</head>
<script type="text/javascript">

JolokiaJS.Request.prototype.postBackend =
    JolokiaJS.Request.postImpl.concrete.XMLHttpRequest
    //JolokiaJS.Request.postImpl.concrete.jQuery
;

function sendViaJQuery() {
    var taRes = jQuery('#taRESPONSE');
    taRes.attr('value',"Sending...");
    var json = jQuery('#taREQUEST').attr('value');
    var ajopt = {
        async:true,
        data:json,
        dataType:'text',
        url:'/jolokia/',
        type:'POST',
        success:function(data) {
            var val = JSON.stringify(JSON.parse(data),undefined,4);
            taRes.attr('value',val);
        },
        error:function(xhr,textStatus,error) {
            taRes.attr('value',"ERROR:\nXHR="+JSON.stringify(xhr)
                        +"\ntextStatus="+textStatus
                        +"\nerrorThrown="+error);
        }
    };
    //alert("opts:\n"+JSON.stringify(ajopt,undefined,4));
    jQuery.ajax(ajopt);
}
function sendViaRequest() {

    var taRes = jQuery('#taRESPONSE');
    taRes.attr('value',"Sending...");

    // Get JSON request from TEXTAREA:
    var json = jQuery('#taREQUEST').attr('value');
    try {
        json = JSON.parse(json);
    }
    catch(e) {
        alert("Could not parse request as JSON:\n"+json);
        return;
    }
    var req = new JolokiaJS.Request(json);
    var popt = {
        method:'POST',
        onResponse:function(response,request) {
            //alert("REQUEST.toJ4PString():\n"+request.toJ4PString());
            var val = response.toJ4PString(4);
            taRes.attr('value',val);
        },
        onError:function(request,requestOpt) {
            taRes.attr('value',"ERROR:\n"+JSON.stringify(requestOpt,undefined,4));
        },
        beforePost: function(request, connectOpt)
        {
            //alert("Posting:\n"+request.toJSON()+"Options:\n"+JSON.stringify(connectOpt,undefined,4));
            jQuery("#jolokiaUrl").text(connectOpt.url);
            return true;
        },
        afterPost: function(request, connectOpt)
        {
        }
    };
    //taRes.attr('value',req.toJ4P());
    req.post(popt);
}

var used        = [];
var max         = [];
var comitted    = [];
var init        = [];
var start       = (new Date()).getTime() / 1000;
function updatePlot(resp,req) {
//  value     => { committed => 15925248, init => 16397184, max => 508887040, used => 5861056 },
    var val = resp.value();
    val.max       /= 1024*1024;
    val.init      /= 1024*1024;
    val.used      /= 1024*1024;
    val.committed  /= 1024*1024;

    $("#max").html(val.max.toFixed(3));
    $("#init").html(val.init.toFixed(3));
    $("#committed").html(val.committed.toFixed(3));
    $("#used").html(val.used.toFixed(3));

    var maxval = 150;
    if(used.length > maxval) used.shift();
    if(max.length > maxval) max.shift();
    if(comitted.length > maxval) comitted.shift();
    if(init.length > maxval) init.shift();

    var ts = resp.timestamp();
    start = ts;
    ts *= 1000.0;

    used.push([ts, val.used]);
    max.push([ts, val.max]);
    init.push([ts, val.init]);
    comitted.push([ts, val.comitted]);

    $.plot($('#heap'), [
        { data: used, label: "Used" },
        { data: max,  label: "Max" },
        { data: init, label: "Init" },
        { data: comitted, label: "Comitted" }
    ], {
        xaxis: {
            mode: "time",
            tickFormatter: function(val, axis) {
                var d = (new Date(val)).getTime() / 1000;
                var diff = start - d;
                return -diff.toFixed(1) + "";
            },
            ticks: 7
        },
        legend: { container: $("#legend"), noColumns: 4 }
    });
}

updatePlot.req = (new JolokiaJS.Request({
        type:'READ',
        mbean:'java.lang:type=Memory',
        attribute:'HeapMemoryUsage'
    }))
    .postOptions({
        onResponse: updatePlot,
        onError:function(req,opt) {alert("Error:\n"+JSON.stringify(opt,undefined,4));}
    });

jQuery(document).ready( function(){
    setInterval( function() { updatePlot.req.post(); }, 2000 );
});
</script>
<body>
REQUEST: <input type="button" onclick="sendViaRequest();" value="Send via JolokiaJS.Request.post()"/>
<input type="button" onclick="sendViaJQuery();" value="Send directly via jQuery"/>
<br/>
<div id="jolokiaUrl"></div>
<br/>
<textarea rows="15" cols="60" id="taREQUEST">
    {
    "type" : "READ",
    "mbean" : "java.lang:type=Memory",
    "attribute" : "HeapMemoryUsage",
    "path" : "used"
  }
</textarea>


<br/>
RESPONSE:<br/>

<textarea rows="15" cols="60" id="taRESPONSE">
</textarea>

<hr/>
Server memory usage (code by <a href="banjo.rbfh.de:11111/graphs/">DaTa</a>):<br/>
<div id="heap" style="width:800px;height:300px;"></div>
 <div id="legend"></div>
 Used: <span id="used"></span><br />
 Max: <span id="max"></span><br />
 Committed: <span id="committed"></span><br />
 Init: <span id="init"></span>
 
</body>
</html>